<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiến độ chung</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        .container {
            width: 100%;
            overflow-x: auto;
            background: white;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #0070C0;
            text-transform: uppercase;
        }

        table {
            border-collapse: collapse;
            white-space: nowrap;
            font-size: 13px;
            width: max-content;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 5px 8px;
            text-align: center;
            vertical-align: middle;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-row-0 th,
        .header-row-1 th {
            font-weight: bold;
            color: black;
        }

        .cat-codinh {
            background-color: #0070C0;
            color: white;
        }

        .cat-didong {
            background-color: #00B050;
            color: white;
        }

        .cat-cuoc {
            background-color: #92D050;
        }

        .cat-chuongtrinh {
            background-color: #0070C0;
            color: white;
        }

        .sub-header {
            background-color: #FFC000;
        }

        .header-row-2 th {
            background-color: #E7E6E6;
            font-weight: bold;
        }

        .bg-red {
            background-color: #FF0000 !important;
            color: white;
            font-weight: bold;
        }

        .bg-green {
            background-color: #92D050 !important;
            font-weight: bold;
        }

        .bg-yellow-light {
            background-color: #FFE699;
        }

        .text-red {
            color: #FF0000;
            font-weight: bold;
        }

        .text-blue {
            color: #0070C0;
            font-weight: bold;
        }

        .row-vietdq9 .fixed-bg {
            background-color: #FFFF00;
        }

        .row-sontv10 .fixed-bg {
            background-color: #BDD7EE;
        }

        .sticky-col-1 {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        thead .sticky-col-1 {
            z-index: 20;
            background-color: transparent;
            /* Keep original header row background */
        }

        .row-vietdq9 .sticky-col-1 {
            background-color: #FFFF00;
        }

        .row-sontv10 .sticky-col-1 {
            background-color: #BDD7EE;
        }

        /* Cuoc table styling */
        #cuocTiendoTable {
            margin-top: 30px;
        }

        #cuocTiendoTable th {
            background-color: #92CDDC;
            /* Light blue header */
        }

        .cuoc-n-1 {
            background-color: #FFC000;
            /* Yellow */
        }

        .cuoc-dau-ky {
            background-color: #ED7D31;
            /* Orange */
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            text-decoration: none;
            padding: 8px 15px;
            background: #0070C0;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            border: 1px solid #000;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-link">⬅ Quay lại Bảng Cá Nhân</a>
        <h1>TIẾN ĐỘ CHUNG</h1>
        <div id="status">Đang tải dữ liệu...</div>
        <table id="tiendoTable" style="display:none;">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>

        <!-- Bảng Chi tiết Thu Cước -->
        <table id="cuocTiendoTable" style="display:none;">
            <thead>
                <tr>
                    <th>Nhân Viên</th>
                    <th>Đầu kỳ</th>
                    <th>Cước ngày n-1</th>
                    <th>Cước thu được<br>trong ngày</th>
                </tr>
            </thead>
            <tbody id="cuocTiendoBody"></tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const [resTiendo, resCuoc] = await Promise.all([
                    fetch('/api/tiendo'),
                    fetch('/api/cuoc')
                ]);
                if (!resTiendo.ok || !resCuoc.ok) throw new Error('Network error');

                const dataTiendo = await resTiendo.json();
                const dataCuoc = await resCuoc.json();

                renderTable(dataTiendo);
                renderCuocTiendoTable(dataCuoc);
            } catch (e) {
                console.error(e);
                document.getElementById('status').textContent = 'Lỗi kết nối. Không thể tải dữ liệu.';
            }
        });

        function renderTable(data) {
            if (!data || data.length < 3) {
                document.getElementById('status').textContent = 'Dữ liệu không hợp lệ.';
                return;
            }
            document.getElementById('status').style.display = 'none';
            document.getElementById('tiendoTable').style.display = 'table';

            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            let maxCols = 0;
            data.forEach(row => { if (row.length > maxCols) maxCols = row.length; });

            for (let i = 0; i < 3; i++) {
                const tr = document.createElement('tr');
                tr.className = 'header-row-' + i;
                const rowData = data[i];

                for (let c = 0; c < maxCols; c++) {
                    const cellValue = rowData[c] || "";
                    if (i < 2 && cellValue !== "") {
                        let colspan = 1;
                        while (c + colspan < maxCols && (rowData[c + colspan] === "" || rowData[c + colspan] === undefined)) {
                            colspan++;
                        }
                        const th = document.createElement('th');
                        th.colSpan = colspan;
                        th.textContent = cellValue;

                        if (i === 0) {
                            const valLower = cellValue.toLowerCase();
                            if (valLower.includes('cố định')) th.className = 'cat-codinh';
                            else if (valLower.includes('di động')) th.className = 'cat-didong';
                            else if (valLower.includes('cước thu')) th.style.backgroundColor = '#5B9BD5'; // Blue hue
                            else if (valLower.includes('cước')) th.className = 'cat-cuoc';
                            else if (valLower.includes('trọng điểm')) th.className = 'cat-chuongtrinh';
                            else th.style.backgroundColor = '#ccc';
                        } else if (i === 1) {
                            th.className = 'sub-header';
                        }

                        if (c === 0) th.classList.add('sticky-col-1');
                        tr.appendChild(th);
                        c += colspan - 1;
                    } else if (i === 2 || cellValue !== "") {
                        const th = document.createElement('th');
                        th.textContent = cellValue;
                        if (c === 0) th.classList.add('sticky-col-1');
                        tr.appendChild(th);
                    } else {
                        const th = document.createElement('th');
                        if (c === 0) th.classList.add('sticky-col-1');
                        tr.appendChild(th);
                    }
                }
                thead.appendChild(tr);
            }

            for (let i = 3; i < data.length; i++) {
                const rowData = data[i];
                if (!rowData || rowData.length === 0 || rowData.every(c => c === "" || c == null)) continue;

                // Dừng render nếu gặp phần cấu hình/mapping phụ ở cuối file Excel
                if (rowData[0] && rowData[0].toString().includes('TB FTTH phát triển mới')) {
                    break;
                }

                const tr = document.createElement('tr');

                let rowClass = '';
                const nvQuanLy = (rowData[2] || "").toString().toUpperCase();
                if (nvQuanLy.includes('VIETDQ9')) rowClass = 'row-vietdq9';
                else if (nvQuanLy.includes('SONTV10')) rowClass = 'row-sontv10';

                // red separator row handling
                if (!rowData[0] && !rowData[1] && !rowData[2]) {
                    if (rowData.some(cell => cell !== "")) {
                        // it has some data but first 3 columns empty
                    } else {
                        // completely empty row but in the middle? Give it a red background separator maybe
                        tr.style.backgroundColor = '#C00000';
                        tr.style.height = '10px';
                    }
                }

                tr.className = rowClass;

                for (let c = 0; c < maxCols; c++) {
                    const td = document.createElement('td');
                    if (c === 0) td.classList.add('sticky-col-1');
                    let val = rowData[c];
                    if (val === undefined || val === null) val = "";

                    let textVal = val;
                    if (typeof val === 'number') {
                        const thVal = data[2][c] || "";
                        if (thVal === '%' || thVal.toLowerCase().includes('đạt') || thVal.toLowerCase().includes('%')) {
                            textVal = (val * 100).toFixed(0) + '%';
                            if (val < 1) td.className = 'bg-red';
                            else if (val >= 1) td.className = 'bg-green';
                        } else if (thVal === 'Đầu kỳ' || thVal === 'Cước ngày n-1' || (thVal === '' && c > maxCols - 4) || thVal.includes('Cước thu được')) {
                            // Accounting format for newly added Cuoc columns
                            const absVal = Math.abs(val).toLocaleString('en-US', { maximumFractionDigits: 0 });
                            textVal = val < 0 ? `-$${absVal}` : `$${absVal}`;
                            td.style.fontWeight = 'bold';

                            // Specific background colors based on header name
                            if (thVal === 'Đầu kỳ') {
                                td.style.backgroundColor = '#ED7D31'; // Orange
                                td.style.color = 'black';
                            } else {
                                td.style.backgroundColor = '#FFC000'; // Yellow
                                td.style.color = 'black';
                            }
                        } else if (val >= 1000 || val <= -1000 || (typeof rowData[0] === 'string' && rowData[0].includes('_NVKD') && c > 0)) {
                            // Format as money/large number with thousand separators
                            textVal = val.toLocaleString('vi-VN', { maximumFractionDigits: 2 });
                        } else if (thVal.toLowerCase() === 'thiếu' && val > 0) {
                            td.classList.add('text-red');
                            // Add yellow light background for TH/Thiếu column if possible
                            if (!Number.isInteger(val)) textVal = val.toFixed(2);
                        } else if (!Number.isInteger(val)) {
                            // If it's a floating point number not marked as %, probably needs formatting
                            textVal = val.toFixed(2);
                        }
                    } else if (typeof val === 'string' && !isNaN(parseFloat(val))) {
                        // Sometimes excel data comes as string, let's also account for it if needed
                        // But mostly sheet_to_json returns numbers.
                    }

                    if (c < 3 && textVal !== "") td.classList.add('fixed-bg');

                    if (rowData[0] && data[2][c] === 'TH') {
                        // some soft background
                        td.classList.add('bg-yellow-light');
                    }

                    // Specific header background formatting from row 2
                    if (i === 2) {
                        // No need since header is created differently, but just in case
                    }

                    td.textContent = textVal;
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function renderCuocTiendoTable(data) {
            if (!data || data.length < 5) return;

            console.log('cuoc data length:', data.length);
            console.log('cuoc row[6]:', data[6]);

            // Danh sách nhân viên cần hiển thị
            const allowedEmployees = [
                "CNKD_LDG_TAMDT", "CNKD_LDG_ANLT", "CNKD_LDG_LINHPM", "CNKD_LDG_SANGLT",
                "CNKD_LDG_NHUANVD", "CNKD_LDG_HIEUBT", "CNKD_LDG_PHUONGNTT1", "CNKD_LDG_HANGBT",
                "CNKD_LDG_SANGTV", "CNKD_LDG_THUONGNTH", "CNKD_LDG_HUONGVTT", "CNKD_LDG_HUNGTV1"
            ];

            document.getElementById('cuocTiendoTable').style.display = 'table';
            const tbody = document.getElementById('cuocTiendoBody');
            tbody.innerHTML = '';

            // Accounting format
            const formatMoney = (val) => {
                const num = parseFloat(val) || 0;
                const absVal = Math.abs(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
                return num < 0 ? `-$${absVal}` : `$${absVal}`;
            };

            let count = 0;
            // Dữ liệu cước bắt đầu từ dòng 6 (index 6), row 5 là sub-header KH/Tiền
            // Cột 17 = alias nhân viên (CNKD_...), 18 = Đầu kỳ, 19 = Cước n-1, 21 = Cước thu được
            for (let i = 6; i < data.length; i++) {
                const row = data[i];
                if (!row) continue;

                const aliasCode = row[17]; // Alias nhân viên ở cột 17
                console.log(`row[${i}][17]:`, aliasCode);

                if (!aliasCode) continue;
                const aliasStr = aliasCode.toString().trim();

                // Hiển thị nếu có trong danh sách HOẶC bắt đầu bằng CNKD_
                if (!allowedEmployees.includes(aliasStr) && !aliasStr.startsWith('CNKD_')) continue;

                const dauKy = parseFloat(row[18]) || 0;
                const cuocN1 = parseFloat(row[19]) || 0;
                const cuocThu = parseFloat(row[21]) || 0;

                const nvBg = count % 2 === 0 ? 'background-color: white;' : 'background-color: #DDEBF7;';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="${nvBg} text-align: left; padding-left: 10px;">${aliasStr}</td>
                    <td class="cuoc-dau-ky" style="font-weight: bold; text-align: right;">${formatMoney(dauKy)}</td>
                    <td class="cuoc-n-1" style="font-weight: bold; text-align: right;">${formatMoney(cuocN1)}</td>
                    <td class="cuoc-n-1" style="font-weight: bold; text-align: right;">${formatMoney(cuocThu)}</td>
                `;
                tbody.appendChild(tr);
                count++;
            }

            console.log('cuoc rows rendered:', count);
            if (count === 0) {
                document.getElementById('cuocTiendoTable').style.display = 'none';
            }
        }
    </script>
</body>

</html>```